
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Activity 6.22 - 6.25 Geocoding &#8212; TM112 Location Based Computing Notebooks</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Activity 6.20 - Locating Nearby WiFi Hotspots" href="Activity%206.20%20-%20Locating%20Nearby%20Wifi%20Hotspots.html" />
    <link rel="prev" title="Activity 6.16 - Cell Tower Lookup" href="Activity%206.16%20-%20Cell%20Tower%20Lookup.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/OU-logo-83x65.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">TM112 Location Based Computing Notebooks</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Location%20Based%20Computing.html">
   Location Based Computing
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Block 2 Unit 2
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Activity%206.16%20-%20Cell%20Tower%20Lookup.html">
   Activity 6.16 - Cell Tower Lookup
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Activity 6.22 - 6.25 Geocoding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Activity%206.20%20-%20Locating%20Nearby%20Wifi%20Hotspots.html">
   Activity 6.20 - Locating Nearby WiFi Hotspots
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Activity%206.27%20-%20Creating%20annotated%20interactive%20maps%20with%20Python.html">
   Activity 6.27 - Creating annotated interactive maps with Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Activity%206.29%20-%20Modelling%20uncertainty%20in%20simple%20trilateration.html">
   Trilateration Demo
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Block 3 Unit 2
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Block%203%2C%20Part%202%20-%20Box%202.3%20Looking%20back%20%E2%80%93%20Geocoding%20Demos.html">
   Playing With
   <code class="docutils literal notranslate">
    <span class="pre">
     dict
    </span>
   </code>
   s - Geolocation API Data
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Bonus Features
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Bonus%20notebook%20-%20Sonification%20Demo.html">
   Sonification Demo
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Using%20Jupyter%20Notebooks.html">
   Using Jupyter Notebooks
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/Activity 6.22 - 6.25 - Geocoding.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ouseful-course-containers/ou-tm112-notebooks/master?urlpath=tree/work/Activity 6.22 - 6.25 - Geocoding.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#activity-6-22-geocoding-an-address-using-an-api">
   Activity 6.22 - Geocoding an address using an API
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-activities">
     Optional Activities
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#activity-6-23-geocoding-addresses-and-postcodes">
   Activity 6.23 - Geocoding addresses and postcodes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#looking-at-the-data-object-returned-from-the-postcodes-io-api">
     Looking at the data object returned from the
     <code class="docutils literal notranslate">
      <span class="pre">
       postcodes.io
      </span>
     </code>
     API
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#parsing-the-postcodes-io-json-data">
     Parsing the
     <code class="docutils literal notranslate">
      <span class="pre">
       postcodes.io
      </span>
     </code>
     JSON data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Optional Activities
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#activity-6-24-geocoding-an-ip-address">
   Activity 6.24 - Geocoding an IP address
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#activity-6-25-reverse-geocoding-a-postcode">
   Activity 6.25 - Reverse geocoding a postcode
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="activity-6-22-6-25-geocoding">
<h1>Activity 6.22 - 6.25 Geocoding<a class="headerlink" href="#activity-6-22-6-25-geocoding" title="Permalink to this headline">¶</a></h1>
<p>In this notebook, you will learn how to geocode different sorts of location data by making requests to several online APIs (<em>Application Programming Interface</em>) for latitude and longitude co-ordinates associated with those locations.</p>
<p>The aim of the notebook is <em>not</em> to teach you formal approaches for working with APIs or the data that is returned from them. Instead, it’s something to whet your curiosity. Something to show you how, with a few lines of Python code, you can start to work with live, third-party datasources and online services to perform real-world programming tasks.</p>
<p>If something doesn’t work: <em>DON’T PANIC</em>. You won’t break your computer and you won’t break the internet. And you won’t fail the module if you just move on!</p>
<p>The location data we will consider includes:</p>
<ul class="simple">
<li><p><a href="#addresses">Activity 6.22 - Geocoding an address using an API</a></p></li>
<li><p><a href="#postcodes">Activity 6.23 - Geocoding addresses and postcodes</a></p></li>
<li><p><a href="#IPaddresses">Activity 6.24 - Geocoding an IP address</a></p></li>
<li><p><a href="#revgeopostcode">Activity 6.25 - Reverse geocoding a postcode</a></p></li>
</ul>
<p><a name="addresses"></a></p>
<div class="section" id="activity-6-22-geocoding-an-address-using-an-api">
<h2>Activity 6.22 - Geocoding an address using an API<a class="headerlink" href="#activity-6-22-geocoding-an-address-using-an-api" title="Permalink to this headline">¶</a></h2>
<p>When Google Maps first appeared in 2005, it existed primarily as a browser based application. Developers soon started to identify the remote Google services that the application relied on and an official API soon followed, along with APIs for other geo-related services such as geocoding.</p>
<p>Since then, a wide range of other providers have opened up publicly accessible geo-related services, including openly licensed mapping services such as OpenStreetmap, as well as geocoding and geolcation services.</p>
<p>Many of these services are accessed programmatically using an API. Some of them, such as the Google APIs, require personal API keys which are associated with registered users and can be used to track, and bill for, usage. Other services, such as Open Street Map, and its associated <a class="reference external" href="https://nominatim.org/release-docs/develop/api/Search/">Nominatim</a> service, still publish open endpoints that <em>do not</em> require an API key.</p>
<p>Do not worry in this activity about the detail of how the call to the API is constructed using Python code or how the response is constructed. The main aim of this activity is simply to demonstrate that small amounts of code <em>can</em> be used to generate requests to third party online services, parse the response, and do something simple with it. However, if you do peek into the entrails of the data object that is returned, you may be able to identify recognisable things within it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#The requests library makes it easy to call URLs using Python</span>
<span class="kn">import</span> <span class="nn">requests</span>
</pre></div>
</div>
</div>
</div>
<p>Specify the address for which we want to find the geocoded location (you could use your own address here):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">address</span><span class="o">=</span><span class="s1">&#39;Open University, Walton Hall, Milton Keynes, MK7 6AA, UK&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can construct a URL to call on the Nomimatim web service using this address as an argument.</p>
<p>Note that we are also requesting that the service provides a response using JSON (Javascript Object Notation) formatted data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Construct a request to the Nominatim geolocatio service using our desired address</span>
<span class="n">r</span><span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://nominatim.openstreetmap.org/search&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="n">address</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span><span class="s1">&#39;json&#39;</span><span class="p">})</span>
<span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Try rerunning the previous cell with an address that is familiar to you. Does the API find it?</p>
<div class="section" id="optional-activities">
<h3>Optional Activities<a class="headerlink" href="#optional-activities" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>try to display the location of an address you have geolocated on a map using <code class="docutils literal notranslate"><span class="pre">folium_magic</span></code>. Remember, you can pass in the co-ordinates literally; for example: <code class="docutils literal notranslate"><span class="pre">%folium_map</span> <span class="pre">-m</span> <span class="pre">48.8584,2.2945</span> <span class="pre">-z</span> <span class="pre">17</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> folium_magic
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Go for it... :-)</span>
</pre></div>
</div>
</div>
</div>
<p><a name="postcodes"></a></p>
</div>
</div>
<div class="section" id="activity-6-23-geocoding-addresses-and-postcodes">
<h2>Activity 6.23 - Geocoding addresses and postcodes<a class="headerlink" href="#activity-6-23-geocoding-addresses-and-postcodes" title="Permalink to this headline">¶</a></h2>
<p>Postcodes are a widely used form of location data, typically capable of identifying a location to a resolution of a few hundred square metres.</p>
<p>There are several online services that will return geolocation information given a postcode. You have alreay seen how the Google geolocation API can geocode an address, and in many cases it can also geocode a postcode if it can identify it as such; providing a postcode + country name as the address can make this more reliable.</p>
<p>As you are perhaps starting to see from these notebook activities, data is often returned from webservices using the JSON (Javascript Object Notation) data format, although some APIs allow you to specify other formats such as XML.</p>
<p>(One advantage of the JSON response is that it can be immediately consumed by a Javascript script called from inside a webpage.)</p>
<p>JSON and XML both allow data to be represented in a structured, <em>tree</em> based hierarchical format. In this notebook, as well exploring a new API published via the <em><a class="reference external" href="http://postcodes.io">postcodes.io</a></em> website, we’ll start to look in a little bit more detail at how the JSON response is structured.</p>
<div class="section" id="looking-at-the-data-object-returned-from-the-postcodes-io-api">
<h3>Looking at the data object returned from the <code class="docutils literal notranslate"><span class="pre">postcodes.io</span></code> API<a class="headerlink" href="#looking-at-the-data-object-returned-from-the-postcodes-io-api" title="Permalink to this headline">¶</a></h3>
<p>The <em><a class="reference external" href="http://postcodes.io">postcodes.io</a></em> API returns data as hierarchical, tree based JSON object. The tree has the following form:</p>
<p><img alt="Hierarchical structure of postocdes api data, showire results tree with latitude, longitude and codes children, and codes showing admin_district and parish district" src="_images/postodes_io_struct.png" /></p>
<!--- http://blockdiag.com/en/blockdiag/demo.html
{

  "result" -> "postcode";
"result" -> "country";
"result" -> "longitude";
"result" -> "latitude";
"dots" [shape = "dots"];
"result" -> "dots" [style = "none"];
"result" -> "codes";
"codes" -> "admin_district";
"dots2" [shape = "dots"];
"codes" -> "dots2" [style = "none"];
"codes" -> "parish";

})

--->
<p>The <code class="docutils literal notranslate"><span class="pre">result</span></code> node is at the top of the tree with children <code class="docutils literal notranslate"><span class="pre">postcode</span></code>, <code class="docutils literal notranslate"><span class="pre">latitude</span></code>, <code class="docutils literal notranslate"><span class="pre">longitude</span></code> and so on. The <code class="docutils literal notranslate"><span class="pre">codes</span></code> child has further children, such as: <code class="docutils literal notranslate"><span class="pre">admin</span></code> and <code class="docutils literal notranslate"><span class="pre">parish</span></code>.</p>
<p>In <em>python</em>, data structures of this form can be represented using the <code class="docutils literal notranslate"><span class="pre">dict</span></code> (“dictionary”) structure, which you will meet elsewhere in the course.</p>
<p>The <em>python</em> <code class="docutils literal notranslate"><span class="pre">requests</span></code> library has a method that parses a correctly formed JSON response as a <em>python</em> <code class="docutils literal notranslate"><span class="pre">dict</span></code>, or more generally, as a set of <em>nested dicts</em>. In this case, one <code class="docutils literal notranslate"><span class="pre">dict</span></code> structure may be nested inside another to support child, grandchild, great grandchild, and so on, levels of structure.</p>
<p><img alt="Hierarchical structure of postocdes api data, showire results tree with latitude, longitude and codes children, and codes showing admin_district and parish district" src="_images/postodes_io_struct_data.png" /></p>
<p>The contents of different levels of the nested <code class="docutils literal notranslate"><span class="pre">dict</span></code> data structure can be accessed by using a form of associative, relative addressing. For example, if the variable <code class="docutils literal notranslate"><span class="pre">mypostcode</span></code> is set to the <code class="docutils literal notranslate"><span class="pre">dict</span></code> shown above, we could access the contents of the main <code class="docutils literal notranslate"><span class="pre">result</span></code> part of the data structure by writing: <code class="docutils literal notranslate"><span class="pre">mypostcode[&quot;result&quot;]</span></code>.</p>
<p>To obtain the value of items in deeper nested parts of the data structure, we simply add further levels of relative addressing. To fetch the value of the <code class="docutils literal notranslate"><span class="pre">postcode</span></code>, we need to specify the path to it via the <code class="docutils literal notranslate"><span class="pre">result</span></code> node: <code class="docutils literal notranslate"><span class="pre">mypostcode[&quot;result&quot;][&quot;postcode&quot;]</span></code>. To obtain the value of the <code class="docutils literal notranslate"><span class="pre">parish</span></code> in the <code class="docutils literal notranslate"><span class="pre">code</span></code> part of the data structure, we specify the path to it as <code class="docutils literal notranslate"><span class="pre">mypostcode[&quot;result&quot;][&quot;code&quot;][&quot;parish&quot;]</span></code>.</p>
<p>Run the following cells to call the <code class="docutils literal notranslate"><span class="pre">postcodes.io</span></code> API with a particular postcode.</p>
<p>See if you can make sense of the result that is returned.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#The requests library makes it easy to call URLs using Python</span>
<span class="kn">import</span> <span class="nn">requests</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">postcode</span> <span class="o">=</span> <span class="s1">&#39;MK7 6AA&#39;</span>
<span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.postcodes.io/postcodes/</span><span class="si">{PC}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PC</span><span class="o">=</span><span class="n">postcode</span><span class="p">))</span>
<span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Try rerunning the previous cell using different postcodes - can the service locate your home postcode?</p>
</div>
<div class="section" id="parsing-the-postcodes-io-json-data">
<h3>Parsing the <code class="docutils literal notranslate"><span class="pre">postcodes.io</span></code> JSON data<a class="headerlink" href="#parsing-the-postcodes-io-json-data" title="Permalink to this headline">¶</a></h3>
<p>Once we have retrieved the data from the API, and cast it as a <em>python</em> data object, we can look inside it programmatically.</p>
<p>We can also create variables that contain subsets of the response data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">json</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="n">json</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s extract the latitude and longitude values. We can reach them in a variety of ways.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Obtain the lat/long of a postcode</span>
<span class="n">lat</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span>

<span class="n">lon</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span>

<span class="c1">#Display the result</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id1">
<h3>Optional Activities<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>use <code class="docutils literal notranslate"><span class="pre">folium</span> <span class="pre">magic</span></code> to map the location of an address you have provided;</p></li>
<li><p>see if you can create a variable that contains the formatted address of a location object retrieved from the <a class="reference external" href="http://postcods.io">postcods.io</a> API;</p></li>
<li><p>see if you can write a loop that will look up the geolocations of several postcodes, one at a time, appending each response object to a list of responses. To be nice to the API import the <em>python</em> <code class="docutils literal notranslate"><span class="pre">time</span></code> library and add the statement <code class="docutils literal notranslate"><span class="pre">time.sleep(1)</span></code> inside the loop to pause its execution for one second during each iteration.</p></li>
<li><p>use some <code class="docutils literal notranslate"><span class="pre">folium_magic</span></code> to display one or markers for each of your (looped) postcodes. You can use the <code class="docutils literal notranslate"><span class="pre">-M</span></code> switch to add multiple markers from a Python variable; pass in the name of a variable that refers to <em>without</em> the $ prefix. For example, if the markers are assigned to the variable <code class="docutils literal notranslate"><span class="pre">markers</span></code> use the magic <code class="docutils literal notranslate"><span class="pre">%folium_map</span> <span class="pre">-M</span> <span class="pre">markers</span></code>:</p>
<ul>
<li><p>a single <code class="docutils literal notranslate"><span class="pre">dict</span></code>, such as <code class="docutils literal notranslate"><span class="pre">markers={'lat':52.0250,</span> <span class="pre">'lng':-0.7084,'popup':'Open</span> <span class="pre">University,</span> <span class="pre">Walton</span> <span class="pre">Hall'}</span></code></p></li>
<li><p>a single ordered <code class="docutils literal notranslate"><span class="pre">list</span></code>, such as <code class="docutils literal notranslate"><span class="pre">markers=[52.0250,</span> <span class="pre">-0.7084,'Open</span> <span class="pre">University,</span> <span class="pre">Walton</span> <span class="pre">Hall']</span></code></p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">list</span></code> of <code class="docutils literal notranslate"><span class="pre">dict</span></code>s, such as <code class="docutils literal notranslate"><span class="pre">markers=[{'lat':52.0250,</span> <span class="pre">'lng':-0.7084,'popup':'Open</span> <span class="pre">University,</span> <span class="pre">Walton</span> <span class="pre">Hall'},{'lat':52.0,</span> <span class="pre">'lng':-0.70,'popup':'Open</span> <span class="pre">University,</span> <span class="pre">Walton</span> <span class="pre">Hall'}]</span></code></p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">list</span></code> of ordered <code class="docutils literal notranslate"><span class="pre">lists</span></code>, such as <code class="docutils literal notranslate"><span class="pre">markers=[[52.0250,</span> <span class="pre">-0.7084,'Open</span> <span class="pre">University,</span> <span class="pre">Walton</span> <span class="pre">Hall'],</span> <span class="pre">[52.,</span> <span class="pre">-0.7,'Open</span> <span class="pre">University,</span> <span class="pre">Walton</span> <span class="pre">Hall']]</span></code></p></li>
</ul>
</li>
</ul>
<p><a name="IPaddresses"></a></p>
</div>
</div>
<div class="section" id="activity-6-24-geocoding-an-ip-address">
<h2>Activity 6.24 - Geocoding an IP address<a class="headerlink" href="#activity-6-24-geocoding-an-ip-address" title="Permalink to this headline">¶</a></h2>
<p>As well as looking up geolocation data for a <em>postal</em> address, we can also try to look up a location based on the IP address of a computer. There are seveal websites that allow you to lookup the IP address of the device you are using to connect to the internet, and several webservices too.</p>
<p>One such service is the Amazon Web Servies (AWS) CheckIP service: <a class="reference external" href="http://checkip.amazonaws.com/">http://checkip.amazonaws.com/</a> .</p>
<p>We <em>could</em> look up the IP address of the computer the notebooks are running on, but that would return the IP address of the <em>server</em> the notebooks are running on:</p>
<p>The AWS <code class="docutils literal notranslate"><span class="pre">checkip</span></code> service returns an IP address terminated by an end of line (<code class="docutils literal notranslate"><span class="pre">\n</span></code>) character. By using the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library, we can call the URL, access the data response (<code class="docutils literal notranslate"><span class="pre">text</span></code>) and then strip (<code class="docutils literal notranslate"><span class="pre">.strip()</span></code>)) the end-of-line whitespace character from it. But if we’re running the notebook on a cloud host, the IP address returned may not be very useful…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#The requests library makes it easy to call URLs using Python</span>
<span class="kn">import</span> <span class="nn">requests</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">notebookIPaddress</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://checkip.amazonaws.com/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">notebookIPaddress</span>
</pre></div>
</div>
</div>
</div>
<p>Instead, vist the URL <a class="reference external" href="http://checkip.amazonaws.com">http://checkip.amazonaws.com</a> in your brower and make a copy of the IP address it returns. Assign that address to the <code class="docutils literal notranslate"><span class="pre">myIPaddress</span></code> variable below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myIPaddress</span> <span class="o">=</span> <span class="s1">&#39;your.ip.address.here&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>As before, we need to construct a URL to call a appropriate IP geolocation service. The service I’m going to use is <a class="reference external" href="https://ipstack.com/quickstart">ipstack.com</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#We can construct a URL based around the IP address of the machine making the request as follows:</span>
<span class="n">KEY</span><span class="o">=</span><span class="s1">&#39;d19510a436ddca4cb01822325ca40178&#39;</span>
<span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://api.ipstack.com/</span><span class="si">{IP}</span><span class="s1">?access_key=</span><span class="si">{KEY}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">IP</span><span class="o">=</span><span class="n">myIPaddress</span><span class="p">,</span>
                                                          <span class="n">KEY</span><span class="o">=</span><span class="n">KEY</span><span class="p">)</span>
<span class="n">url</span>
</pre></div>
</div>
</div>
</div>
<p>As with the other APIs we have used, the response is provided as a JSON object. You may be getting a feel now for how we might be able to make the request and handle this response.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>If you are using a commercial ISP when you look up your IP address via your browser location bar using <a class="reference external" href="https://freegeoip.net">https://freegeoip.net</a> or <a class="reference external" href="http://checkip.amazonaws.com/">http://checkip.amazonaws.com/</a> - for example, if you are using home broadband through a large ISP - you may find that the location identified is nowhere near you. In this case, the locatin may refer to the physical network datacentre that is managing your network connection.</p>
<p>If you tried to geocode the IP address in <code class="docutils literal notranslate"><span class="pre">notebookIPaddress</span></code>, the result may surprise you. If the notebook and the python process associated with it is running on a server hosted in the cloud. In some cases, the response may often be empty as the location of the IP address is unknown - the physical location of the IP address may be hard to pin down if the servers they are assigned to are floating in the cloud!</p>
<p><a name="revgeopostcode"></a></p>
</div>
<div class="section" id="activity-6-25-reverse-geocoding-a-postcode">
<h2>Activity 6.25 - Reverse geocoding a postcode<a class="headerlink" href="#activity-6-25-reverse-geocoding-a-postcode" title="Permalink to this headline">¶</a></h2>
<p><em>Reverse geocoding</em> refers to the ability to go <em>from</em> a geocoded location, represented as a latitude/longitude pair, for example, back to an address or location.</p>
<p>The <em><a class="reference external" href="http://postcodes.io">postcodes.io</a></em> service supports reverse geocoding by accpeting a latitude/longitude pair and returning the postcode area associated with it, along with a data about other admonistrative gepgraphy regions that the location falls within.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Use the OU Walton Hall Location</span>
<span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="p">(</span><span class="mf">52.0250</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7084</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.postcodes.io/postcodes?lon=</span><span class="si">{lon}</span><span class="s1">&amp;lat=</span><span class="si">{lat}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">))</span>
<span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>One thing to note from this response is that it actually returns <em>two</em> locations. We can write a simple bit of Python code to iterate through the results list and pull out the postcodes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Test - can we retrieve the postcode from the first item (list index 0) in the results list?</span>
<span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;postcode&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Iterate through all the results</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;postcode&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, let’s create a function to display the postcode(s) associated with a supplied latitude, longitude pair.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_postcode_from_latlon</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Use the postodes.io API to retrieve postcodes for a location&#39;&#39;&#39;</span>
    
    <span class="n">r</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.postcodes.io/postcodes?lon=</span><span class="si">{lon}</span><span class="s1">&amp;lat=</span><span class="si">{lat}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">))</span>
    
    <span class="c1">#Parse the JSON response</span>
    <span class="n">json</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    
    <span class="c1">#Extract the results list</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
    
    <span class="c1">#Create an empty list to hold the postcodes</span>
    <span class="n">postcodes</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1">#Iterate through the results</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="c1">#Extract the postcode</span>
        <span class="n">postcodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;postcode&#39;</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">postcodes</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_postcode_from_latlon</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this notebook, you have learned how to geocode several different sorts of location identifer - postcodes, postal addresses and IP addresses.</p>
<p>You have also seen how we can take the JSON data returned from the geolocation services and parse it as python dict that we can then start to work <em>as data</em>, for example, by plotting markers associated with identified locations on an interactive map.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "ouseful-course-containers/ou-tm112-notebooks",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="Activity%206.16%20-%20Cell%20Tower%20Lookup.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Activity 6.16 - Cell Tower Lookup</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="Activity%206.20%20-%20Locating%20Nearby%20Wifi%20Hotspots.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Activity 6.20 - Locating Nearby WiFi Hotspots</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Tony Hirst, on behalf of the OU TM112 Module Team<br/>
        
            &copy; Copyright The Open University, 2018-2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>